---
title: "Analysis"
output: html_document
---

```{r setup/libraries/read data/rename, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = "999")

# libraries
library(tidyverse)
library(psych)
```


```{r open data}
adata_each <- readRDS("Data/1_final_each2022-05-25 18:05:51.rds") %>% 
  rename(industry = "Branche") %>%
  industries_rename()
  
adata_amr <- readRDS("Data/2_final_2022-05-25 10:41:28.rds") %>%
  industries_rename()

```

# Macro

## Entropy
```{r Entropy x population plot}
pop_entropy <- ggplot(data = adata_each %>% dplyr::filter(entropy > 0), aes(x = log(bevoelkerung, base = 10), y = log(entropy))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor(method = "pearson", label.x.npc = 0.6, label.y.npc = 0.1)
pop_entropy

```


```{r Entropy x AMR plot}
amr_entro <- adata_each %>% 
  group_by(AMR, bevoelkerung) %>% 
  summarise(mean_entropy = mean(entropy, na.rm = T)) %>% glimpse()

pop_entropy <- ggplot(data = amr_entro, aes(x = log(bevoelkerung, base = 10), y = mean_entropy)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor(method = "pearson", label.x.npc = 0.6, label.y.npc = 0.1)
pop_entropy


```



## Other measures
```{r, Types x population}
pop_typ <- ggplot(data = adata_each, aes(x = log(bevoelkerung, base = 10), y = types)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor(method = "pearson")

pop_typ
```

```{r, pr_noun + population}
pop_noun <- ggplot(data = adata_each, aes(x = log(bevoelkerung, base = 10), y = sents)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  ggpubr::stat_cor(method = "pearson")

pop_noun

```


# Inter-industry

## Frequencies

```{r, frequencies per industry}
#histogram of frequencies, log(population) -> scaling observable for some industries

p <- ggplot(data = adata_each, aes(x = log(bevoelkerung, base = 10))) +
  geom_histogram(bins = 50) +
  #geom_smooth() +
  #geom_jitter() +
  facet_wrap(vars(industry))
p

```


## Boxplot of entropy

```{r, boxplot per industry}
box_pl <- ggplot(data = adata_each %>% dplyr::filter(industry %in% c("Agriculture, forestry, horticulture", "IT, computers, telecommunication")), aes(y = entropy)) +
  geom_boxplot() +
  facet_wrap(vars(industry))
box_pl


```


## Bootstrap 
```{r bootstrapped CIs entropy differences}
library(boot)

boots_function <- function(data,index){
  d <- data[index,]
  return(mean(d$entropy, na.rm = T))  
}

boots <- adata_each %>%
  group_split(industry) %>% 
  
  map_dfr(function(x){
    mean_entropy <- mean(x$entropy, na.rm = T)
    
    basic <- boot.ci(boot(x, boots_function, R = 10000), type = "basic")$basic
    CI.LL <- basic[4]
    CI.UL <- basic[5]
    
    res <- tibble(mean_entropy = round(mean_entropy, digits = 4),
                  CI.LL = round(CI.LL, digits = 4),
                  CI.UL = round(CI.UL, digits = 4))
    
    return(res)
    
    })
boots

saveRDS(boots, file = "Data/entropy_industry bootstrap_ci_26.05.rds")

```


```{r combine boots and plot CIs, fig.height=6, fig.width=10}
boots <- readRDS("Data/entropy_industry bootstrap_ci_26.05.rds")

industry_entropy_df <- adata_each %>% 
  group_by(industry) %>% 
  summarise(mean_entropy = round(mean(entropy, na.rm = T), digits = 4))

boots_entropy <- merge(industry_entropy_df, boots)

be <- ggplot(data = boots_entropy) +
    geom_col(aes(x = reorder(industry, -mean_entropy), y = mean_entropy, fill = industry)) +
    coord_flip() +
    #scale_fill_manual(values = c("blue", "black", "deepskyblue1", "yellow2", "chartreuse4", "purple", "red")) +
    geom_errorbar(aes(x = industry, ymin = CI.LL, ymax = CI.UL), color = "darkred") +
    labs(x =  "industry", title = "average entropy of job ads \n 95% bootstrap CI after 10000 resampling interations") +
    theme(legend.position = "none")
    
be

```


```{r homskedasticity of entropy in industries}
#Variance of all industries, dataframe
comp_variance <- adata_amr %>% 
  group_by(industry) %>%
  summarise(var_entropy = var(mean_entropy, na.rm = T))

#Rule of thumb for Homoskedasticity: largest variance 1.5x smallest variance
max(comp_variance$var_entropy)
1.5 * min(comp_variance$var_entropy)
```

## Entropy and scaling per industry

```{r scaling/entropy, echo=FALSE}

# This function takes adata which was grouped by industry beforehand and returns scaling beta for each industry
scaling <- function(industry_tibble){
  
  model1 <- lm(formula = log(n) ~ log(population),
               data = industry_tibble)
  
  return(round(model1$coefficients[2], digits = 3))
}

#group by industry, calculate summaries e.g. scaling
industry_data <- adata_amr %>% group_by(industry) %>%
  summarise(beta = scaling(cur_data()),
            mean_entropy = mean(mean_entropy, na.rm = T),
            mean_tok = mean(mean_tok, na.rm = T),
            mean_types = mean(mean_types, na.rm = T))

entropy_industry <- ggplot(data = industry_data, aes(x = mean_entropy, y = beta)) +
  geom_point(colour = "darkorange") +
  ggpubr::stat_cor(method = "pearson") +
  geom_smooth(method = "lm", colour = "darkred") +
  ggrepel::geom_text_repel(aes(label = industry)) +
  labs(x = "Average entropy of job ads", y = "Scaling coefficient (Î²)") +
  theme_minimal()
entropy_industry
```



# Intra-industry

```{r descriptives}

#Descriptives of all industries
adata  %>% select(mean_entropy, industry) %>% describe.by(adata$industry)


```

## Beta estimates
Does the beta coefficient increase with population size in the industry sectors?


Raw material extraction has the highest beta: 0.004716474483
A 1% increase in population is associated with a 0.04% increase in textual information density of job ads.
-> Negative relationships as well, e.g. IT, computers, telecommunication -> weird

```{r intra industry model}
industry_model <- function(df) {
  lm(log(entropy) ~ log(bevoelkerung), data = df)
}

by_industry <- adata_each %>% 
  dplyr::filter(entropy > 0) %>% #drop cases where entropy is smaller than 1 -> undefefined if log(0)
  group_by(industry) %>%
  nest()

by_industry <- by_industry %>%
  mutate(model = map(data, industry_model))

models_by_industry <- by_industry %>% 
  mutate(tidy = map(model, broom::tidy)) %>% 
  select(-data, -model) %>%
  unnest(tidy) %>%
  dplyr::filter(term == "log(bevoelkerung)")


```



```{r}
waste <- adata_each %>% dplyr::filter(industry == "Waste management, energy supply, water supply")

model <- lm(log(entropy) ~ log(bevoelkerung), data = waste)
summary(model)

```


```{r intra industry facet amr}
#entropy
e <- ggplot(data = adata_amr, aes(x = log(population, base = 10), y = log(mean_entropy))) +
  geom_point(alpha = 0.5) +
  ggpubr::stat_cor(method = "pearson", label.y.npc = 0.1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(industry))
e


```

```{r intra industry facet pop}
#entropy
e <- ggplot(data = adata_each, aes(x = log(bevoelkerung, base = 10), y = log(entropy))) +
  geom_point(alpha = 0.5) +
  ggpubr::stat_cor(method = "pearson", label.y.npc = 0.1) +
  geom_smooth(method = "lm") +
  facet_wrap(vars(industry))
e

```


# Maps

```{r, map of all jobads}

amr_n <- adata_each %>% group_by(AMR) %>% summarise(n_anzeigen = n())

amr_sf <- sf::st_read("Shapefiles/Deutschland/amr250/AMR250.shp") %>%
  inner_join(amr_n, by = "AMR")

a <- ggplot(data = amr_sf) +
  geom_sf(aes(fill=n_anzeigen)) +
  scale_fill_continuous(low = "white", high = "darkred") +
  labs(fill = "Number of Job Ads") +
  theme_minimal() 
a

```



```{r, map of knowledge complexity x AMR}

amr_entro <- adata_each %>% 
  group_by(AMR, bevoelkerung) %>% 
  summarise(mean_entropy = mean(entropy, na.rm = T))

amr_sf <- sf::st_read("Shapefiles/Deutschland/amr250/AMR250.shp") %>%
  inner_join(amr_entro, by = "AMR")

a <- ggplot(data = amr_sf) +
  geom_sf(aes(fill=mean_entropy)) +
  scale_fill_continuous(low = "white", high = "darkred") +
  labs(fill = "Knowledge complexity") +
  theme_minimal() 
a

```

